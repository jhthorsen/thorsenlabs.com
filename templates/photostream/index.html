{% extends "layouts/base.html" %}

{% block title %}Photostream{% endblock %}
{% block description %}Alternative frontend to public iCloud photo sharing.{% endblock %}

{% block content %}
<main role="document" class="document-width">
  <article id="photostream" hx-select="[role=document]" hx-target="[role=document]">
    {% if album is defined %}
      <header>
        <h1>{{ article.title }}</h1>
        <p>{{ article.description }}</p>
      </header>
      <div class="photostream-overview" hx-on:click="thorsen.openViewer(event, null)">
        {% for photo in album.photos %}
          {% if photo.derivatives.video %}
            <figure class="video" data-ts="{{ photo.dateCreated }}" data-guid="{{ photo.photoGuid }}" data-viewer-checksum="{{ photo.derivatives.video.checksum }}">
          {% elif photo.derivatives.image %}
            <figure class="image" data-ts="{{ photo.dateCreated }}" data-guid="{{ photo.photoGuid }}" data-viewer-checksum="{{ photo.derivatives.image.checksum }}">
          {% else %}
            <figure data-guid="{{ photo.photoGuid }}" data-ts="{{ photo.dateCreated }}" class="unknown">
          {% endif %}
            <img alt="" data-thumb-checksum="{{ photo.derivatives.thumb.checksum }}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
            <!-- TODO figcaption {% if photo.caption | length == 0 %}hidden{% endif %}>{{ photo.caption | safe }}</figcaption -->
          </figure>
        {% endfor %}
      </div>
    {% else %}
      <header>
        <h1>Photostream</h1>
        <p>
          This service is an alternative frontend to Apple's official "shared album" iCloud web page.
        </p>
      </header>

      <form method="get" action="/photostream" hx-boost="false" hx-on:submit="thorsen.submitPhotostreamForm(event)">
        <label>
          iCloud sharing URL
          <input type="text" name="icloud_id" placeholder="https://www.icloud.com/sharedalbum/#xxxxxxxxxxxxxxx" required value="{{ query.icloud_id | default(value="") }}">
        </label>
        <p><button class="button">See shared album</button></p>
      </form>
      <blockquote>The images and videos are served by Apple.</blockquote>
    {% endif %}
  </article>
</main>

<div class="photostream-viewer">
  <!-- generated by javascript -->
</div>

<div class="photostream-viewer-controls">
  <!-- https://www.svgrepo.com/collection/solar-bold-icons -->
  <a href="#close" hx-on:click="thorsen.openViewer(event, 'close')">
    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="24.00" height="24" rx="12" fill="var(--nav-border-color)" strokewidth="0"></rect>
      <path fill-rule="evenodd" clip-rule="evenodd" d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12ZM8.96963 8.96965C9.26252 8.67676 9.73739 8.67676 10.0303 8.96965L12 10.9393L13.9696 8.96967C14.2625 8.67678 14.7374 8.67678 15.0303 8.96967C15.3232 9.26256 15.3232 9.73744 15.0303 10.0303L13.0606 12L15.0303 13.9696C15.3232 14.2625 15.3232 14.7374 15.0303 15.0303C14.7374 15.3232 14.2625 15.3232 13.9696 15.0303L12 13.0607L10.0303 15.0303C9.73742 15.3232 9.26254 15.3232 8.96965 15.0303C8.67676 14.7374 8.67676 14.2625 8.96965 13.9697L10.9393 12L8.96963 10.0303C8.67673 9.73742 8.67673 9.26254 8.96963 8.96965Z" fill="var(--nav-color)"></path>
    </svg>
  </a>

  <a href="#next" hx-on:click="thorsen.openViewer(event, 1)">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="24.00" height="24" rx="12" fill="var(--nav-border-color)" strokewidth="0"></rect>
      <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM9.96967 8.46967C10.2626 8.17678 10.7374 8.17678 11.0303 8.46967L14.0303 11.4697C14.3232 11.7626 14.3232 12.2374 14.0303 12.5303L11.0303 15.5303C10.7374 15.8232 10.2626 15.8232 9.96967 15.5303C9.67678 15.2374 9.67678 14.7626 9.96967 14.4697L12.4393 12L9.96967 9.53033C9.67678 9.23744 9.67678 8.76256 9.96967 8.46967Z" fill="var(--nav-color)">
    </svg>
  </a>

  <a href="#prev" hx-on:click="thorsen.openViewer(event, -1)">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="24.00" height="24" rx="12" fill="var(--nav-border-color)" strokewidth="0"></rect>
      <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM14.0303 8.46967C14.3232 8.76256 14.3232 9.23744 14.0303 9.53033L11.5607 12L14.0303 14.4697C14.3232 14.7626 14.3232 15.2374 14.0303 15.5303C13.7374 15.8232 13.2626 15.8232 12.9697 15.5303L9.96967 12.5303C9.67678 12.2374 9.67678 11.7626 9.96967 11.4697L12.9697 8.46967C13.2626 8.17678 13.7374 8.17678 14.0303 8.46967Z" fill="var(--nav-color)"></path>
    </svg>
  </a>
</div>

<script>
  ((thorsen) => {
    const phototStreamId = '{{ query.icloud_id | default(value = article.id) }}';
    const intervalId = setInterval(onScroll, 250);

    thorsen.openViewer = async (event, inc) => {
      event.preventDefault();
      pauseVideos();

      const {$viewer} = getContainers();
      if (inc === 'close') return $viewer.classList.remove('open');

      let [behavior, left] = ['instant', -1];
      if (inc === null) {
        const $figure = findFigure($viewer, event.target.closest('[data-viewer-checksum]'));
        if (!$figure) return; // Clicked on something in .photostream-overview that does not have a dup
        left = $figure.offsetLeft;
        loadWebAsset($figure);
      } else {
        behavior = 'smooth';
        left = $viewer.scrollLeft + ($viewer.querySelector('figure').offsetWidth * inc);
      }

      if (left < 0) {
        $viewer.classList.remove('open');
      } else {
        $viewer.classList.add('open');
        $viewer.scrollTo({left, top: 0, behavior});
      }
    };

    thorsen.submitPhotostreamForm = async (event) => {
      if (event) event.preventDefault();
      const $form = document.querySelector('form[action="/photostream"]');
      const phototStreamId = $form.querySelector('input[name=icloud_id]').value.replace(/.*#/, '');
      if (!phototStreamId.length) return;

      try {
        const url = `/photostream/${phototStreamId}`;
        await htmx.ajax('GET', url, {source: 'main', target: 'main', swap: 'outerHTML'});
        history.pushState({}, '', url);
      } catch (err) {
        console.error({method: 'submitPhotostreamForm', err});
      }
    };

    async function fetchWebAssets(guids) {
      if (guids.length === 0) return [];

      const res = await fetch(`/photostream/${phototStreamId}/webassets`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json;charset=UTF-8'},
        body: JSON.stringify(guids),
      });

      const json = await res.json();
      return json.items || [];
    }

    function generateViewer() {
      const {$overview, $viewer} = getContainers();
      const observer = new IntersectionObserver((entries, _observer) => {
        if (!$viewer.classList.contains('open')) return;

        for (const entry of entries) {
          const $el = entry.target;
          if (entry.isIntersecting) {
            loadWebAsset($el);
            pauseVideos();

            // Scroll into view in overview page
            findFigure($overview, $el).scrollIntoView({behavior: 'instant', block: 'center'});
          }
        }
      }, {root: $viewer});

      for (const $figure of $overview.querySelectorAll('.image, .video')) {
        const $dup = document.createElement('figure');
        $dup.className = $figure.className;
        $dup.dataset.viewerChecksum = $figure.dataset.viewerChecksum;
        $viewer.appendChild($dup);
        observer.observe($dup);
      }
    }

    function getContainers() {
      return {$overview: document.querySelector('.photostream-overview'), $viewer: document.querySelector('.photostream-viewer')};
    }

    function findFigure($container, $figure) {
      return $figure && $container.querySelector(`[data-viewer-checksum="${$figure.dataset.viewerChecksum}"]`);
    }

    function loadWebAsset($figure) {
      const src = $figure.dataset.src || '';
      const urlRe = /^[A-Za-z0-9-._~:/?#\[\]@!$&'()*+,;%=]+$/;
      if (!src.match(urlRe)) return; // Prevent XSS

      if ($figure.classList.contains('video')) {
        $figure.innerHTML = `<video controls src="${src}"></video>`;
      } else {
        $figure.innerHTML = `<img src="${src}" alt="">`;
      }

      delete $figure.dataset.src;
    }

    function pauseVideos() {
      for (const $video of document.querySelectorAll('video')) {
        $video.pause();
      }
    }

    async function onScroll() {
      const scrollY = Math.max(window.scrollY, 0);
      if (onScroll.y != undefined && Math.abs(onScroll.y - scrollY) < 20) return;
      if (onScroll.y == undefined) generateViewer();
      onScroll.y = scrollY;

      const {$overview, $viewer} = getContainers();
      if (!$overview || !$viewer) return clearTimeout(intervalId);

      let guids = [];
      for (const $figure of $overview.querySelectorAll('.image, .video')) {
        const isIntersecting
           = $figure.offsetTop >= scrollY - ($figure.offsetHeight * 4)
          && $figure.offsetTop <= scrollY + window.innerHeight + ($figure.offsetHeight * 4);

        if (isIntersecting) {
          $figure.classList.add('is-intersecting');
        } else {
          $figure.classList.remove('is-intersecting');
        }

        if ($figure.dataset.guid && guids.length < 20) {
          if (isIntersecting || guids.length) {
            guids.push($figure.dataset.guid);
            $figure.dataset.guid = '';
          }
        }
      }

      const items = await fetchWebAssets(guids);
      for (const checksum in items) {
        const $thumb = document.querySelector(`[data-thumb-checksum="${checksum}"]`);
        if (!$thumb) continue;

        const thumbItem = items[checksum];
        const $figure = findFigure($viewer, $thumb.closest('figure'));
        const viewerItem = items[$figure.dataset.viewerChecksum];
        $thumb.src = `https://${thumbItem.url_location}${thumbItem.url_path}`;
        $figure.dataset.src = `https://${viewerItem.url_location}${viewerItem.url_path}`;
      }
    }
  })(window.thorsen || (window.thorsen = {}));
</script>

{% endblock %}
